<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stuff for Sale - The Grand Casita Theater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #110000; /* Darker red */
        }
        .font-cinzel {
            font-family: 'Cinzel', serif;
        }
        .text-brand-gold {
            color: #fde047; /* Tailwind's yellow-300 */
        }
        .bg-brand-gold {
            background-color: #fde047;
        }
        .hover\:bg-brand-gold-dark:hover {
            background-color: #facc15; /* Tailwind's yellow-400 */
        }
        .bg-brand-dark {
             background-color: #380000;
        }
        .bg-brand-card {
            background-color: #2a0000;
        }
        .loader {
            border: 4px solid rgba(253, 224, 71, 0.2);
            border-top: 4px solid #fde047;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #image-modal-backdrop.hidden, #claim-modal.hidden {
            display: none;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .featured-card {
            background: linear-gradient(45deg, #2a0000, #380000);
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto px-4 py-8 md:py-16 max-w-6xl">

        <header class="text-center mb-12">
            <h1 class="font-cinzel text-4xl md:text-6xl text-brand-gold font-bold tracking-wider">Stuff for Sale</h1>
            <p class="text-xl text-gray-400 mt-2">Limited time offers from the theater vault!</p>
        </header>

        <!-- Featured Item Section -->
        <section id="featured-section" class="mb-16 hidden">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold font-cinzel text-brand-gold">Deal of the Day</h2>
                <p id="countdown-timer" class="text-xl text-gray-400 mt-2">New deal in: <span class="font-bold text-white">--:--:--</span></p>
            </div>
            <div id="featured-product-card" class="featured-card rounded-2xl shadow-2xl p-8 flex flex-col md:flex-row items-center gap-8 text-white border-2 border-yellow-300/20">
                <!-- Featured product will be injected here -->
            </div>
        </section>

        <main>
            <h2 class="text-3xl font-bold font-cinzel text-center mb-8 text-brand-gold">All Items</h2>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Product cards will be inserted here by JavaScript -->
                <div id="loading-spinner" class="col-span-full flex justify-center items-center h-64">
                    <div class="loader"></div>
                </div>
            </div>
        </main>

    </div>

    <!-- Modal for entering name -->
    <div id="claim-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-brand-card p-8 rounded-lg shadow-xl max-w-sm w-full border-2 border-yellow-300/50">
            <h3 class="text-2xl font-bold mb-2 text-brand-gold font-cinzel">Confirm Purchase</h3>
            <p class="text-gray-300 mb-6">Enter your name to purchase <strong id="modal-product-name" class="text-white"></strong>.</p>
            <div>
                <label for="claimerName" class="sr-only">Your Name</label>
                <input type="text" id="claimerName" placeholder="Enter your full name" required class="w-full bg-gray-900 border-yellow-300/20 text-white rounded-lg p-3 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition">
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-claim-button" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition-colors font-cinzel">Cancel</button>
                <button id="confirm-claim-button" class="px-6 py-2 bg-brand-gold hover:bg-brand-gold-dark text-stone-900 font-bold rounded-lg transition-colors font-cinzel">Buy Now</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for enlarging image -->
    <div id="image-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden cursor-pointer">
        <img id="enlarged-image" src="" alt="Enlarged product" class="max-w-full max-h-full object-contain rounded-lg">
    </div>


    <script>
        const productListContainer = document.getElementById('product-list');
        const loadingSpinner = document.getElementById('loading-spinner');
        const featuredSection = document.getElementById('featured-section');
        const featuredProductCard = document.getElementById('featured-product-card');
        const countdownTimer = document.getElementById('countdown-timer');
        const claimModal = document.getElementById('claim-modal');
        const modalProductName = document.getElementById('modal-product-name');
        const claimerNameInput = document.getElementById('claimerName');
        const cancelClaimButton = document.getElementById('cancel-claim-button');
        const confirmClaimButton = document.getElementById('confirm-claim-button');
        const imageModalBackdrop = document.getElementById('image-modal-backdrop');
        const enlargedImage = document.getElementById('enlarged-image');

        let productToClaimId = null;

        const webAppUrl = 'https://script.google.com/macros/s/AKfycbwgcspU4XtMsslxxV8nQl9-sY7A7wRhAf9CqPV72ybzuG-Qh7aZ5U384IiUvUkpjUgJZw/exec';

        // --- FETCH AND RENDER PRODUCTS ---
        async function fetchAndRenderProducts() {
            loadingSpinner.style.display = 'flex';
            productListContainer.innerHTML = '';
            productListContainer.appendChild(loadingSpinner);

            try {
                const response = await fetch(`${webAppUrl}?type=products`);
                if (!response.ok) throw new Error('Network response was not ok.');
                
                const data = await response.json();
                
                const availableProducts = data.products.filter(p => p.status !== 'claimed');
                const featuredProduct = getDailyFeaturedItem(availableProducts);

                renderFeaturedProduct(featuredProduct);
                renderProducts(data.products, featuredProduct);

            } catch (error) {
                console.error('Error fetching products:', error);
                productListContainer.innerHTML = `<p class="col-span-full text-center text-red-400">Could not load products. Please try again later.</p>`;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        function getDailyFeaturedItem(products) {
            if (!products || products.length === 0) return null;
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const index = dayOfYear % products.length;
            return products[index];
        }

        function renderFeaturedProduct(product) {
            if (!product) {
                featuredSection.style.display = 'none';
                return;
            }
            
            featuredSection.style.display = 'block';
            const price = product.price ? `$${Number(product.price).toFixed(2)}` : 'FREE';
            const imageUrl = product.imageURL || 'https://placehold.co/600x400/2a0000/fde047?text=No+Image';

            featuredProductCard.innerHTML = `
                <div class="md:w-1/2">
                    <img src="${imageUrl}" alt="${product.productName}" class="w-full h-80 object-cover rounded-xl shadow-lg cursor-pointer product-image" data-enlarge-src="${imageUrl}">
                </div>
                <div class="md:w-1/2 text-center md:text-left">
                    <h3 class="text-4xl font-bold font-cinzel text-white">${product.productName}</h3>
                    <p class="text-gray-300 mt-4 mb-6">${product.description}</p>
                    <div class="flex flex-col md:flex-row items-center justify-center md:justify-start gap-6">
                         <p class="text-5xl font-bold text-brand-gold">${price}</p>
                         <button data-product-id="${product.id}" data-product-name="${product.productName}" class="claim-button w-full md:w-auto bg-brand-gold hover:bg-brand-gold-dark text-stone-900 font-bold py-4 px-8 rounded-lg transition duration-300 text-lg font-cinzel">
                            Buy Now
                        </button>
                    </div>
                </div>
            `;
        }


        function renderProducts(products, featuredProduct) {
            productListContainer.innerHTML = '';
            if (!products || products.length === 0) {
                productListContainer.innerHTML = `<p class="col-span-full text-center text-gray-400">Nothing for sale right now. Check back soon!</p>`;
                return;
            }

            products.forEach(product => {
                if (featuredProduct && product.id === featuredProduct.id) return;

                const isClaimed = product.status === 'claimed';
                const price = product.price ? `$${Number(product.price).toFixed(2)}` : 'FREE';
                const imageUrl = product.imageURL || 'https://placehold.co/600x400/2a0000/fde047?text=No+Image';

                const card = document.createElement('div');
                card.className = `product-card bg-brand-card rounded-xl shadow-lg flex flex-col transition-all duration-300 border border-yellow-300/10 ${isClaimed ? 'opacity-50 grayscale' : ''}`;
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" alt="${product.productName}" class="w-full h-56 object-cover rounded-t-xl cursor-pointer product-image" data-enlarge-src="${imageUrl}">
                        ${isClaimed ? `<div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center rounded-t-xl"><span class="text-white text-2xl font-bold font-cinzel transform -rotate-12">SOLD</span></div>` : ''}
                    </div>
                    <div class="p-6 flex-grow flex flex-col">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold font-cinzel text-brand-gold">${product.productName}</h3>
                            <p class="text-gray-400 mt-2 mb-4">${product.description}</p>
                        </div>
                        <div class="mt-auto flex justify-between items-center">
                            <p class="text-2xl font-bold text-white">${price}</p>
                            ${isClaimed ? `
                                <div class="text-sm text-right">
                                    <p class="font-semibold text-gray-300">Sold to:</p>
                                    <p class="text-gray-500">${product.claimedBy || 'Anonymous'}</p>
                                </div>
                            ` : `
                                <button data-product-id="${product.id}" data-product-name="${product.productName}" class="claim-button bg-brand-gold hover:bg-brand-gold-dark text-stone-900 font-bold py-2 px-5 rounded-lg transition duration-300 font-cinzel">
                                    Buy Now
                                </button>
                            `}
                        </div>
                    </div>
                `;
                productListContainer.appendChild(card);
            });
        }
        
        // --- COUNTDOWN TIMER ---
        function startCountdown() {
            const countdownInterval = setInterval(() => {
                const now = new Date();
                const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
                const timeLeft = midnight.getTime() - now.getTime();

                if (timeLeft < 0) {
                    countdownTimer.innerHTML = "New deal coming soon!";
                    clearInterval(countdownInterval);
                    return;
                }

                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                const formattedHours = String(hours).padStart(2, '0');
                const formattedMinutes = String(minutes).padStart(2, '0');
                const formattedSeconds = String(seconds).padStart(2, '0');

                countdownTimer.innerHTML = `New deal in: <span class="font-bold text-white">${formattedHours}:${formattedMinutes}:${formattedSeconds}</span>`;
            }, 1000);
        }

        // --- EVENT LISTENERS ---
        
        document.body.addEventListener('click', function(e) {
            if (e.target.classList.contains('claim-button')) {
                productToClaimId = e.target.dataset.productId;
                modalProductName.textContent = e.target.dataset.productName;
                claimModal.classList.remove('hidden');
                claimerNameInput.focus();
            }
            if (e.target.classList.contains('product-image')) {
                enlargedImage.src = e.target.dataset.enlargeSrc;
                imageModalBackdrop.classList.remove('hidden');
            }
        });

        cancelClaimButton.addEventListener('click', () => {
            claimModal.classList.add('hidden');
            productToClaimId = null;
            claimerNameInput.value = '';
        });

        imageModalBackdrop.addEventListener('click', () => {
            imageModalBackdrop.classList.add('hidden');
        });

        confirmClaimButton.addEventListener('click', async () => {
            const claimerName = claimerNameInput.value.trim();
            if (!claimerName) {
                alert('Please enter your name.');
                return;
            }

            const payload = {
                type: 'claim_product',
                productId: productToClaimId,
                claimerName: claimerName
            };

            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));

            confirmClaimButton.disabled = true;
            confirmClaimButton.textContent = 'Processing...';

            try {
                const response = await fetch(webAppUrl, { method: 'POST', body: formData });
                const result = await response.json();

                if (result.success) {
                    alert('Success! The item is yours.');
                    fetchAndRenderProducts(); // Refresh the list
                } else {
                    throw new Error(result.error || 'Failed to claim item.');
                }
            } catch (error) {
                console.error('Claiming error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                confirmClaimButton.disabled = false;
                confirmClaimButton.textContent = 'Buy Now';
                cancelClaimButton.click(); // Close and reset modal
            }
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderProducts();
            startCountdown();
        });
    </script>

</body>
</html>
