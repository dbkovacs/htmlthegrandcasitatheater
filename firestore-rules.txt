rules_version = '2';

// Helper function to check for admin email
function isAdmin() {
  // VVV YOU MUST EDIT THIS LIST VVV
  let ADMIN_EMAILS = ['dbkovacs@gmail.com'];
  // ^^^ YOU MUST EDIT THIS LIST ^^^
  return request.auth != null && request.auth.token.email in ADMIN_EMAILS;
}

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Public Content ---
    match /movies/{movieId} {
      // Anyone can read movie info
      allow read: if true;
      // Anyone can create a new movie suggestion (for signups)
      allow create: if true;
      // Only admins can approve, update, or delete movies
      allow update, delete: if isAdmin();

      // --- Reservations Subcollection ---
      match /reservations/{reservationId} {
        // Anyone with an anonymous ID can read or create a reservation
        allow read, create: if request.auth != null;
        // Only admins can update or delete a reservation
        allow update, delete: if isAdmin();
      }
    }

    match /settings/{settingId} {
      // Anyone can read settings (e.g., homepage mode)
      allow read: if true;
      // Only admins can change settings
      allow write: if isAdmin();
    }

    match /layouts/{layoutId} {
      // Anyone can read seating layouts
      allow read: if true;
      // Only admins can change layouts
      allow write: if isAdmin();
    }

    // --- Auction Rules ---
    match /auctionItems/{itemId} {
      // Anyone can read the auction items
      allow read: if true;
      // Only admins can create, update, or delete items
      allow create, update, delete: if isAdmin();

      // --- Bids Subcollection ---
      match /bids/{bidId} {
        // Any anonymous user can create (place) a bid
        allow create: if request.auth != null;
        // Only admins can read, update, or delete bids
        allow read, update, delete: if isAdmin();
      }
    }

    // --- Santa Signup Rules ---

    // This is the public list of taken slots.
    match /publicSantaConfig/{dateId} {
      // **THIS IS THE BUG FIX**
      // Allow ANYONE (even before auth) to read the list of taken slots.
      allow read: if true;
      // ONLY allow an authenticated user (our anonymous transaction) to write
      allow write: if request.auth != null;
    }

    // This is the private list of approved phone numbers.
    match /familyPhoneList/{listId} {
      // Allow read ONLY if the user is authenticated (for the transaction)
      allow read: if request.auth != null;
      // Only an admin should be able to write/update this list
      allow write: if isAdmin();
    }

    // This is the private booking information.
    match /santaBookings/{bookingId} {
      // Allow create ONLY if the user is authenticated (for the transaction)
      allow create: if request.auth != null;
      // Only an admin should be able to read or modify bookings
      allow read, update, delete: if isAdmin();
    }

  }
}